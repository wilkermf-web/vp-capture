name: Capture Vaidepromo

on:
  workflow_dispatch:
    inputs:
      origin:
        description: "IATA origem (ex: GYN)"
        required: false
        default: GYN
      dest:
        description: "IATA destino (ex: CAC)"
        required: false
        default: CAC
      date:
        description: "Data (AAAA-MM-DD)"
        required: false
        default: 2025-11-30
      debug:
        description: "DEBUG=1 para logs extras"
        required: false
        default: "1"

  # opcional: rode todo dia às 09:00 UTC
  # schedule:
  #   - cron: "0 9 * * *"

permissions:
  contents: write

concurrency:
  group: capture-${{ github.ref }}
  cancel-in-progress: false

jobs:
  capture-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci || npm i

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Resolve inputs (origin/dest/date)
        id: cfg
        shell: bash
        run: |
          ORIGIN="${{ github.event.inputs.origin }}"
          DEST="${{ github.event.inputs.dest }}"
          DATE_IN="${{ github.event.inputs.date }}"
          DEBUG_IN="${{ github.event.inputs.debug }}"
          # defaults de segurança:
          : "${ORIGIN:=GYN}"
          : "${DEST:=CAC}"
          : "${DATE_IN:=2025-11-30}"
          : "${DEBUG_IN:=1}"
          echo "origin=$ORIGIN" >> $GITHUB_OUTPUT
          echo "dest=$DEST"     >> $GITHUB_OUTPUT
          echo "date=$DATE_IN"  >> $GITHUB_OUTPUT
          echo "debug=$DEBUG_IN" >> $GITHUB_OUTPUT

      - name: Capture page (Vaidepromo)
        env:
          ORIGIN: ${{ steps.cfg.outputs.origin }}
          DEST:   ${{ steps.cfg.outputs.dest }}
          DATE:   ${{ steps.cfg.outputs.date }}
          DEBUG:  ${{ steps.cfg.outputs.debug }}
        run: node scripts/capture.js

      - name: Commit & push data
        shell: bash
        run: |
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "Sem mudanças para commitar."
          else
            MSG="capture: ${{
              steps.cfg.outputs.origin
            }}-${{
              steps.cfg.outputs.dest
            }} ${{
              steps.cfg.outputs.date
            }}"
            git commit -m "$MSG"
            git push
          fi
