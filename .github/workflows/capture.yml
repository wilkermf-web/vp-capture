name: Capture Vaidepromo

on:
  workflow_dispatch:
    inputs:
      origin:
        description: "IATA origem (ex: GYN)"
        required: false
        default: GYN
      dest:
        description: "IATA destino (ex: CAC)"
        required: false
        default: CAC
      date:
        description: "Data (AAAA-MM-DD)"
        required: true
  # Para executar todo dia automaticamente (opcional), remova o comentário abaixo:
  # schedule:
  #   - cron: "9 9 * * *"   # 09:09 UTC diário

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  capture-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
      # pega o repositório inteiro (precisa para commitar data/)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps + Playwright
        run: |
          npm ci --ignore-scripts --no-audit --no-fund || npm i
          npx playwright install --with-deps chromium

      # 1) CAPTURA (usa scripts/capture.js)
      - name: Capture page (Vaidepromo)
        env:
          ORIGIN: ${{ inputs.origin || 'GYN' }}
          DEST:   ${{ inputs.dest   || 'CAC' }}
          DATE:   ${{ inputs.date   }}
          DEBUG:  "1"
        run: node scripts/capture.js

      # 2) RECONSTRÓI O ÍNDICE PÚBLICO (data/public e /latest)
      - name: Build public index
        run: node scripts/build-index.js

      # 3) COMMITA OS ARQUIVOS GERADOS
      - name: Commit & push data
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "capture: ${DATE:-manual} ${ORIGIN:-GYN}-${DEST:-CAC}" || echo "Nada para commitar"
          git push

      # 4) PUBLICA NO GITHUB PAGES
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Prepare site bundle (gh-pages)
        run: |
          set -e
          rm -rf site
          mkdir -p site/data/public
          cp -R data/public/* site/data/public/ || true
          cat > site/index.html <<'HTML'
          <!doctype html><meta charset="utf-8">
          <title>vp-capture</title>
          <h1>Índice público</h1>
          <p><a href="data/public/index.json">data/public/index.json</a></p>
          <p><a href="data/public/index.md">data/public/index.md</a></p>
          HTML

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
