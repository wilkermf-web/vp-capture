name: Capture Vaidepromo

on:
  workflow_dispatch:
    inputs:
      origin:
        description: "IATA origem (ex: GYN)"
        required: false
        default: GYN
      dest:
        description: "IATA destino (ex: CAC)"
        required: false
        default: CAC
      start_date:
        description: "Data inicial (AAAA-MM-DD). Vazio = hoje"
        required: false
        default: ""
      days:
        description: "Quantos dias (ex: 90)"
        required: false
        default: "90"
      delay_ms:
        description: "Pausa entre dias (ms)"
        required: false
        default: "3500"
      debug:
        description: "DEBUG=1 para logs extras"
        required: false
        default: "0"

permissions:
  contents: write

jobs:
  capture-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Instala deps SÓ se existir package.json (funciona com ou sem package-lock.json)
      - name: Install deps (if package.json exists)
        run: |
          if [ -f package.json ]; then
            npm ci || npm i
          else
            echo "Sem package.json — pulando npm install"
          fi

      - name: Install Playwright Chromium
        run: npx -y playwright@1.56.1 install --with-deps chromium

      - name: Run range (N dias em loop)
        shell: bash
        run: |
          set -e
          ORIGIN="${{ github.event.inputs.origin || 'GYN' }}"
          DEST="${{ github.event.inputs.dest   || 'CAC' }}"
          START="${{ github.event.inputs.start_date }}"
          DAYS="${{ github.event.inputs.days      || '90' }}"
          DELAY="${{ github.event.inputs.delay_ms || '3500' }}"
          DEBUG="${{ github.event.inputs.debug    || '0' }}"

          # Data inicial: hoje no fuso de SP, se não informada
          if [ -z "$START" ]; then
            START=$(TZ=America/Sao_Paulo date +%F)
          fi

          echo "Iniciando captura: $ORIGIN->$DEST | start=$START | days=$DAYS | delay_ms=$DELAY | debug=$DEBUG"

          for ((i=0;i<DAYS;i++)); do
            D=$(date -d "$START + $i day" +%F)
            echo "==> Dia $((i+1))/$DAYS: $D"
            ORIGIN="$ORIGIN" DEST="$DEST" DATE="$D" DEBUG="$DEBUG" node scripts/capture.js \
              || echo "Falha no dia $D, continuando..."
            if [ $i -lt $((DAYS-1)) ]; then
              sleep $((DELAY/1000))
            fi
          done

      - name: Commit & push data
        shell: bash
        run: |
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "Sem mudanças para commitar."
          else
            MSG="capture-range: ${{ github.event.inputs.origin || 'GYN' }}-${{ github.event.inputs.dest || 'CAC' }} start=${{ github.event.inputs.start_date || 'today' }} days=${{ github.event.inputs.days || '90' }}"
            git commit -m "$MSG"
            git push
          fi

      - name: Upload artifact (opcional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-${{ github.event.inputs.origin || 'GYN' }}-${{ github.event.inputs.dest || 'CAC' }}-${{ github.run_number }}
          path: |
            data/**
            public/**
          if-no-files-found: warn
          retention-days: 7
