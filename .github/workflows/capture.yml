name: Capture Vaidepromo

on:
  workflow_dispatch:
    inputs:
      origin:
        description: "IATA origem (ex: GYN)"
        required: false
        default: GYN
      dest:
        description: "IATA destino (ex: CAC)"
        required: false
        default: CAC
      date:
        description: "Data (AAAA-MM-DD)"
        required: false
        default: 2025-11-30
  # Se quiser rodar automático todo dia, descomente:
  # schedule:
  #   - cron: "0 9 * * *"  # 09:00 UTC

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # 1) CAPTURA (usa seu capture.js atual)
      - name: Capture
        env:
          ORIGIN: ${{ github.event.inputs.origin }}
          DEST:   ${{ github.event.inputs.dest }}
          DATE:   ${{ github.event.inputs.date }}
          OUTPUT_DIR: data
          DEBUG: "1"
        run: node capture.js

      # 2) PUBLICA O "LATEST" ESTÁVEL DA ROTA
      - name: Publish stable "latest"
        env:
          ORIGIN: ${{ github.event.inputs.origin }}
          DEST:   ${{ github.event.inputs.dest }}
          DATE:   ${{ github.event.inputs.date }}
        run: |
          set -e
          ORIGIN="${ORIGIN:-GYN}"
          DEST="${DEST:-CAC}"
          DATE="${DATE:-2025-11-30}"
          ROUTE="${ORIGIN}-${DEST}"
          BASE="data/${DATE}_${ROUTE}"
          if [ ! -d "$BASE" ]; then
            echo "Base '$BASE' não existe (nenhum run gerou dados)"; exit 0
          fi
          # pega a pasta de timestamp mais recente
          STAMP="$(ls -1 "$BASE" | tail -n1)"
          PUB="data/public/${ROUTE}/latest"
          mkdir -p "$PUB"

          # publica artefatos principais
          cp -f "$BASE/$STAMP/results.csv"  "$PUB/results.csv"  || true
          cp -f "$BASE/$STAMP/results.json" "$PUB/results.json" || true
          cp -f "$BASE/$STAMP/screenshot.png" "$PUB/screenshot.png" || true

          # manifesto informativo
          echo "{\"date\":\"$DATE\",\"route\":\"$ROUTE\",\"stamp\":\"$STAMP\"}" > "$PUB/manifest.json"

      # 3) RECONSTRÓI O ÍNDICE PÚBLICO (lista tudo que há em data/*/*)
      - name: Build public index
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: node indexer.js

      # 4) COMMIT ÚNICO (dados + latest + índice)
      - name: Commit & push (dados + latest + index)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          if git diff --cached --quiet; then
            echo "Nenhum arquivo novo."
          else
            git commit -m "capture: dados atualizados + latest + índice público"
            git push
          fi
