name: Build snapshot YYYY-MM-DD_FROM-TO.csv

on:
  workflow_dispatch:
    inputs:
      from:
        description: "IATA de origem"
        required: true
        default: "GYN"
      to:
        description: "IATA de destino"
        required: true
        default: "CAC"

permissions:
  contents: write

jobs:
  build-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Node (no deps needed)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Gerar snapshot único em public/YYYY-MM-DD_FROM-TO.csv
        env:
          ROUTE_FROM: ${{ github.event.inputs.from }}
          ROUTE_TO:   ${{ github.event.inputs.to }}
          TZ: America/Sao_Paulo  # "hoje" no fuso BR
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          function ensureDir(dir){ fs.mkdirSync(dir, { recursive:true }); }

          function listResultsFiles(root="data"){
            const out=[];
            function walk(d){
              if(!fs.existsSync(d)) return;
              for(const ent of fs.readdirSync(d, { withFileTypes:true })){
                const full = path.join(d, ent.name);
                if(ent.isDirectory()) walk(full);
                else if(ent.isFile() && ent.name === 'results.csv') out.push(full);
              }
            }
            walk(root);
            out.sort((a,b)=>a.localeCompare(b));
            return out;
          }

          // parser ; com aspas opcionais
          function parseCSVSemi(text){
            const lines = text.trim().split(/\r?\n/).filter(Boolean);
            const splitSemi = (line) => {
              const out=[]; let cur=''; let inQ=false;
              for (let i=0;i<line.length;i++){
                const ch=line[i];
                if (ch === '"'){
                  if (inQ && line[i+1] === '"'){ cur+='"'; i++; }
                  else inQ = !inQ;
                } else if (ch === ';' && !inQ){
                  out.push(cur); cur='';
                } else {
                  cur += ch;
                }
              }
              out.push(cur);
              return out.map(s=>s.trim());
            };
            if(!lines.length) return { header:[], rows:[] };
            const header = splitSemi(lines[0]).map(h=>String(h).trim().toLowerCase());
            const rows = lines.slice(1)
              .map(splitSemi)
              .filter(arr=>arr.length===header.length)
              .map(arr=>Object.fromEntries(header.map((h,i)=>[h, arr[i]])));
            return { header, rows };
          }

          // normaliza 1.234,56 | 1,234.56 | 1234.56
          function normalizePrice(v){
            if(v==null) return null;
            let s = String(v).trim().replace(/[^\d.,-]/g, '');
            const lastDot = s.lastIndexOf('.');
            const lastCom = s.lastIndexOf(',');
            const decIdx  = Math.max(lastDot, lastCom);
            if (decIdx >= 0) {
              const decSep = s[decIdx];
              const thousandSep = decSep === '.' ? ',' : '.';
              s = s.replace(new RegExp('\\' + thousandSep, 'g'), '');
              if (decSep === ',') s = s.replace(',', '.');
            }
            const n = Number.parseFloat(s);
            return Number.isFinite(n) ? Number(n.toFixed(2)) : null;
          }

          function todayStr(tz='America/Sao_Paulo'){
            const parts = new Intl.DateTimeFormat('en-CA', {
              timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'
            }).formatToParts(new Date());
            const bag = Object.fromEntries(parts.filter(p=>p.type!=='literal').map(p=>[p.type,p.value]));
            return `${bag.year}-${bag.month}-${bag.day}`;
          }

          const FROM = (process.env.ROUTE_FROM || 'GYN').toUpperCase();
          const TO   = (process.env.ROUTE_TO   || 'CAC').toUpperCase();
          const ROUTE = `${FROM}-${TO}`;

          const all = listResultsFiles('data');
          // filtra apenas pastas que contenham _FROM-TO no caminho
          const files = all.filter(fp =>
            fp.includes(`_${ROUTE}${path.sep}`) || fp.includes(`_${ROUTE}/`) || fp.includes(`_${ROUTE}\\`)
          );

          const byDate = new Map(); // date -> [prices]

          for(const fp of files){
            try{
              const txt = fs.readFileSync(fp,'utf8');
              const { rows } = parseCSVSemi(txt);
              for(const r of rows){
                const date = (r.date || '').trim();
                const price = normalizePrice(r.price_brl);
                if(!date || price==null) continue;
                if(!byDate.has(date)) byDate.set(date, []);
                byDate.get(date).push(price);
              }
            }catch(e){
              console.error('Falhou em', fp, e.message);
            }
          }

          // dedup + ordena preços por dia
          const dates = Array.from(byDate.keys()).sort();
          for(const d of dates){
            byDate.set(d, Array.from(new Set(byDate.get(d))).sort((a,b)=>a-b));
          }

          ensureDir('public');
          const lines = ['"date";"price_brl"'];
          for(let i=0;i<dates.length;i++){
            const d = dates[i];
            for(const p of byDate.get(d)) lines.push(`"${d}";"${p.toFixed(2)}"`);
            if(i<dates.length-1) lines.push('');
          }

          const snapshot = `${todayStr()}_${ROUTE}.csv`;
          fs.writeFileSync(path.join('public', snapshot), lines.join('\n')+'\n', 'utf8');
          console.log(`[snapshot] criado public/${snapshot} | dias=${dates.length} | linhas=${lines.length}`);
          NODE

      - name: Commit & push snapshot (se mudou)
        shell: bash
        run: |
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add public/*.csv
          if git diff --cached --quiet; then
            echo "Sem mudanças para commitar."
          else
            git commit -m "snapshot: ${{ github.event.inputs.from }}-${{ github.event.inputs.to }} (apenas arquivo do dia)"
            git push
          fi
