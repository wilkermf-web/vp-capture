name: range-90d

on:
  workflow_dispatch:
    inputs:
      from:      { description: "IATA origem", required: true, default: "GYN" }
      to:        { description: "IATA destino", required: true, default: "CAC" }
      days:      { description: "Dias para frente", required: true, default: "90" }
      delay_ms:  { description: "Pausa entre dias (ms)", required: true, default: "4000" }

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Debug – listar arquivos na raiz
        run: |
          pwd
          ls -la

      - name: Instalar dependências (se houver package.json)
        run: |
          if [ -f package.json ]; then
            echo "package.json encontrado – instalando deps"
            npm ci || npm i
          else
            echo "Sem package.json – pulando npm install"
          fi

      - name: Instalar browsers do Playwright (mesmo sem package.json)
        run: |
          npx -y playwright@1.48.2 install --with-deps

      - name: Rodar varredura (dia a dia)
        run: |
          node run-range.cjs --from "${{ inputs.from }}" --to "${{ inputs.to }}" --days "${{ inputs.days }}" --delay-ms "${{ inputs.delay_ms }}"

      - name: Commit e push dos dados gerados
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "data: ${{ inputs.from }}-${{ inputs.to }} (run ${{ github.run_number }})"
          file_pattern: |
            data/**
            public/results.csv

      - name: Upload artifact (opcional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-${{ inputs.from }}-${{ inputs.to }}-${{ github.run_number }}
          path: |
            data/**
            public/results.csv
          if-no-files-found: warn
          retention-days: 7
